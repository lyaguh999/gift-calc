<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор подарков</title>

  <style>
    :root { --bg:#0b1220; --card:#121b2e; --text:#e8eefc; --muted:#aab6d3; --line:#233152; --accent:#4ea1ff; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg), #0a1020); color: var(--text);
      padding: 24px;
    }
    .wrap { max-width: 1100px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }

    .layout {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 14px;
      align-items: start;
    }

    .card {
      background: rgba(18,27,46,0.92);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    .top {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 12px;
      align-items: end;
      margin-bottom: 12px;
    }

    label { display:block; color: var(--muted); font-size: 13px; margin: 0 0 6px; }

    input {
      width: 100%;
      box-sizing: border-box;
      background: #0c1428;
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 10px;
      outline: none;
      font-variant-numeric: tabular-nums;
    }
    input:focus {
      border-color: rgba(78,161,255,0.7);
      box-shadow: 0 0 0 3px rgba(78,161,255,0.15);
    }
    .num { text-align: right; }

    .btn {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      font-family: inherit;
      font-size: 14px;
      transition: 0.2s;
      white-space: nowrap;
    }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn svg { width: 16px; height: 16px; fill: currentColor; }

    .readonly {
      background: rgba(12,20,40,0.55);
      color: rgba(232,238,252,0.95);
      cursor: not-allowed;
    }

    .hint { color: var(--muted); font-size: 13px; line-height: 1.35; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--line); padding: 10px 8px; vertical-align: middle; }
    th { color: var(--muted); font-weight: 650; text-align: left; font-size: 13px; }
    td:last-child, th:last-child { text-align: right; }
    .row-total { font-weight: 750; font-variant-numeric: tabular-nums; }

    .footer {
      display:flex; justify-content: space-between; align-items: center; gap: 12px;
      margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--line);
      flex-wrap: wrap;
    }
    .grand { font-size: 18px; font-weight: 850; font-variant-numeric: tabular-nums; }

    .side-title { font-weight: 800; margin: 0 0 10px; font-size: 16px; }
    .side-grid { display: grid; gap: 10px; }
    .side-row { display: grid; grid-template-columns: 1fr 120px; gap: 10px; align-items: center; }
    .eq {
      margin-top: 6px;
      padding: 10px;
      border: 1px dashed var(--line);
      border-radius: 12px;
      background: rgba(12,20,40,0.35);
      font-variant-numeric: tabular-nums;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .eq .lhs { color: var(--muted); }
    .eq .rhs { font-weight: 900; }

    .support-block {
      margin-top: 20px;
      padding: 16px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--line);
      border-radius: 14px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    .support-icon {
      flex-shrink: 0;
      width: 32px; height: 32px;
      background: rgba(78,161,255,0.1);
      border-radius: 8px;
      display: grid; place-items: center;
      color: var(--accent);
    }
    .support-icon svg { width: 18px; height: 18px; fill: currentColor; }
    .support-text p { margin: 0 0 8px; }
    .support-text p:last-child { margin-bottom: 0; }
    .support-text b { color: var(--text); font-weight: 700; }

    .mon-head {
      display:flex; justify-content: space-between; align-items: baseline;
      gap: 10px; flex-wrap: wrap;
    }
    .pill {
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid var(--line);
      background: rgba(12,20,40,0.35);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #ff6b6b; }
    .dot.ok { background: #4ade80; }
    .dot.wait { background: #fbbf24; }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .top { grid-template-columns: 1fr; }
      .side-row { grid-template-columns: 1fr 140px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Калькулятор подарков</h1>

    <div class="layout">
      <!-- ЛЕВАЯ ЧАСТЬ: калькулятор -->
      <div class="card">
        <div class="top">
          <div class="hint">
            Введите «Цена за 1 шт для всех» — она применится ко всем товарам.<br>
            Количество для <b>«Другой Подарок»</b> берётся автоматически из блока справа: сумма 3 полей.<br>
            Данные не сохраняются: после обновления страницы значения сбросятся.
          </div>

          <div>
            <label for="globalPrice">Цена за 1 шт для всех</label>
            <input id="globalPrice" class="num" inputmode="decimal" placeholder="0.00" />
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap: wrap;">
              <button id="resetBtn" type="button" class="btn">Сбросить</button>

              <a href="https://github.com/lyaguh999/gift-calc" target="_blank" rel="noopener noreferrer" class="btn">
                <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
                Исходный код
              </a>
            </div>
          </div>
        </div>

        <table aria-label="Таблица товаров">
          <thead>
            <tr>
              <th style="width:40%">Товар</th>
              <th style="width:20%">Цена за 1 шт</th>
              <th style="width:15%">Кол-во</th>
              <th style="width:25%">Итого</th>
            </tr>
          </thead>

          <tbody id="tbody">
            <tr>
              <td style="vertical-align: middle;">
  <span style="display:inline-flex; align-items:center; gap:10px; line-height:1.15;">
    <img
      src="icons/huge.png"
      alt=""
      width="22"
      height="22"
      style="display:block; width:22px; height:22px; object-fit:contain; flex:0 0 22px;"
    >
    <span>Огромный подарок</span>
  </span>
</td>
              <td><input class="price num" inputmode="decimal" placeholder="0.00" /></td>
              <td><input class="qty num" inputmode="decimal" value="1" /></td>
              <td class="row-total num">0.00</td>
            </tr>

            <tr>
              <td style="vertical-align: middle;">
  <span style="display:inline-flex; align-items:center; gap:10px; line-height:1.15;">
    <img src="icons/big.png" alt="" width="22" height="22"
         style="display:block; width:22px; height:22px; object-fit:contain; flex:0 0 22px;">
    <span>Большой подарок</span>
  </span>
</td>
              <td><input class="price num" inputmode="decimal" placeholder="0.00" /></td>
              <td><input class="qty num" inputmode="decimal" value="1" /></td>
              <td class="row-total num">0.00</td>
            </tr>

            <tr>
              <td>
  <span class="gift-label">
    <img class="gift-img" src="icons/rest.png" alt="">
    Другой Подарок
  </span>
</td>
              <td><input class="price num" inputmode="decimal" placeholder="0.00" /></td>
              <td>
                <input id="otherQty" class="qty num readonly" inputmode="decimal" value="0" readonly />
              </td>
              <td class="row-total num">0.00</td>
            </tr>
          </tbody>
        </table>

        <div class="footer">
          <div class="hint">Итог считается автоматически при изменении цены или количества.</div>
          <div class="grand">Общая сумма: <span id="grandTotal">0.00</span></div>
        </div>
      </div>

      <!-- ПРАВАЯ ЧАСТЬ: подсчет мелких подарков -->
      <div class="card">
        <h2 class="side-title">Подсчет мелких подарков</h2>

        <div class="side-grid">
          <div class="side-row">
            <div class="hint">Количество 1</div>
            <input id="small1" class="num" inputmode="decimal" value="0" />
          </div>

          <div class="side-row">
            <div class="hint">Количество 2</div>
            <input id="small2" class="num" inputmode="decimal" value="0" />
          </div>

          <div class="side-row">
            <div class="hint">Количество 3</div>
            <input id="small3" class="num" inputmode="decimal" value="0" />
          </div>

          <div class="eq" aria-label="Формула суммы">
            <div class="lhs">
              <span id="eqA">0</span> + <span id="eqB">0</span> + <span id="eqC">0</span> =
            </div>
            <div class="rhs">
              <span id="eqSum">0</span>
            </div>
          </div>

          <div class="hint">
            Эта сумма автоматически подставляется в <b>«Другой Подарок → Кол-во»</b>.
          </div>
        </div>
      </div>
    </div>

    <!-- МОНИТОРИНГ ЦЕН -->
    <div class="card" style="margin-top: 14px;">
      <div class="mon-head">
        <h2 style="margin:0; font-size:18px;">Мониторинг цен подарков (Тех. работы)</h2>
        <div class="pill" id="monPill">
          <span class="dot wait" id="monDot"></span>
          <span>Обновлено: <span id="monUpdated">—</span></span>
          <button class="btn" type="button" id="monRefreshBtn" style="padding:6px 10px; font-size:12px;">Обновить</button>
        </div>
      </div>

      <div class="hint" style="margin-top:8px;">
        Берём данные из истории аукциона через Worker (секреты не на сайте). Обновление каждые 2 минуты.
      </div>

      <div style="overflow-x:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Предмет</th>
              <th style="text-align:right;">Мин. за 1 шт</th>
              <th style="text-align:right;">Средняя за 1 шт</th>
              <th style="text-align:right;">Записей</th>
              <th style="text-align:right;">В калькулятор</th>
            </tr>
          </thead>
          <tbody id="monBody">
            <tr><td colspan="5" style="padding:12px; color:var(--muted);">Загрузка…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="hint" style="margin-top:8px;">
        Кнопка «Средняя» подставит цену в поле «Цена за 1 шт для всех».
      </div>
    </div>

    <!-- БЛОК ПОДДЕРЖКИ -->
    <div class="support-block">
      <div class="support-icon">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4z"/>
        </svg>
      </div>
      <div class="support-text">
        <p>Этот проект держится на двух вещах: литре кофе и моем бесконечном энтузиазме. Я сделал это для души, но, как говорится, "спасибо" в карман не положишь (хотя и оно чертовски приятно!).</p>
        <p>Если хотите подкинуть мотивации для новых свершений, можете отправить что-нибудь мне на почту, указав ник <b>NewerTEST</b>. Буду благодарен за любую весточку!</p>
      </div>
    </div>

  </div>

  <script>
    // ---------------------------
    // Калькулятор
    // ---------------------------
    const tbody = document.getElementById('tbody');
    const grandTotalEl = document.getElementById('grandTotal');
    const globalPriceEl = document.getElementById('globalPrice');
    const resetBtn = document.getElementById('resetBtn');

    const otherQtyEl = document.getElementById('otherQty');
    const small1El = document.getElementById('small1');
    const small2El = document.getElementById('small2');
    const small3El = document.getElementById('small3');
    const eqAEl = document.getElementById('eqA');
    const eqBEl = document.getElementById('eqB');
    const eqCEl = document.getElementById('eqC');
    const eqSumEl = document.getElementById('eqSum');

    function parseNumber(value) {
      if (typeof value !== 'string') return 0;
      const cleaned = value.trim().replace(/\s+/g, '').replace(',', '.');
      const n = Number.parseFloat(cleaned);
      return Number.isFinite(n) ? Math.max(0, n) : 0;
    }
    function fmtMoney(n) {
      return (Math.round(n * 100) / 100).toFixed(2);
    }
    function fmtQty(n) {
      if (Number.isInteger(n)) return String(n);
      const rounded = Math.round(n * 100) / 100;
      return String(rounded);
    }

    function recalc() {
      let grand = 0;
      for (const tr of tbody.querySelectorAll('tr')) {
        const price = parseNumber(tr.querySelector('.price')?.value ?? '');
        const qty = parseNumber(tr.querySelector('.qty')?.value ?? '');
        const total = price * qty;

        tr.querySelector('.row-total').textContent = fmtMoney(total);
        grand += total;
      }
      grandTotalEl.textContent = fmtMoney(grand);
    }

    function applyGlobalPrice() {
      const gp = globalPriceEl.value; // сохраняем формат ввода (точка/запятая)
      for (const priceInput of tbody.querySelectorAll('.price')) {
        priceInput.value = gp;
      }
      recalc();
    }

    function updateSmallGiftsSum() {
      const a = parseNumber(small1El.value);
      const b = parseNumber(small2El.value);
      const c = parseNumber(small3El.value);
      const sum = a + b + c;

      eqAEl.textContent = fmtQty(a);
      eqBEl.textContent = fmtQty(b);
      eqCEl.textContent = fmtQty(c);
      eqSumEl.textContent = fmtQty(sum);

      otherQtyEl.value = fmtQty(sum);
      recalc();
    }

    globalPriceEl.addEventListener('input', applyGlobalPrice);

    tbody.addEventListener('input', (e) => {
      if (e.target.matches('.price, .qty')) recalc();
    });

    [small1El, small2El, small3El].forEach(el => {
      el.addEventListener('input', updateSmallGiftsSum);
    });

    resetBtn.addEventListener('click', () => {
      globalPriceEl.value = '';
      for (const tr of tbody.querySelectorAll('tr')) {
        tr.querySelector('.price').value = '';
      }
      const rows = tbody.querySelectorAll('tr');
      rows[0].querySelector('.qty').value = '1';
      rows[1].querySelector('.qty').value = '1';

      small1El.value = '0';
      small2El.value = '0';
      small3El.value = '0';

      updateSmallGiftsSum();
    });

    // ---------------------------
    // Мониторинг (через Worker)
    // ---------------------------
    const WORKER_URL = "https://YOUR-WORKER.workers.dev/prices"; // <-- ЗАМЕНИ НА СВОЙ
    const MON_REFRESH_MS = 120000;

    const monBody = document.getElementById('monBody');
    const monUpdated = document.getElementById('monUpdated');
    const monRefreshBtn = document.getElementById('monRefreshBtn');
    const monDot = document.getElementById('monDot');

    function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtInt(n){
      const x = Number(n || 0);
      return Number.isFinite(x) ? Math.round(x).toLocaleString("ru-RU") : "0";
    }

    async function loadMonitor() {
      monDot.className = "dot wait";
      try {
        const r = await fetch(WORKER_URL, { cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const data = await r.json();

        monUpdated.textContent = data.updatedAt ? new Date(data.updatedAt).toLocaleString("ru-RU") : "—";

        const items = Array.isArray(data.items) ? data.items : [];
        if (!items.length) {
          monBody.innerHTML = `<tr><td colspan="5" style="padding:12px; color:#ff6b6b;">Нет данных</td></tr>`;
          monDot.className = "dot";
          return;
        }

        monBody.innerHTML = items.map((x, idx) => {
          const avg = Number(x.avgPerUnit || 0);
          const min = Number(x.minPerUnit || 0);
          const samples = Number(x.samples || 0);
          return `
            <tr>
              <td>${esc(x.name)}</td>
              <td style="text-align:right;">${fmtInt(min)} ₽</td>
              <td style="text-align:right; color: var(--accent);">${fmtInt(avg)} ₽</td>
              <td style="text-align:right; color: var(--muted);">${fmtInt(samples)}</td>
              <td style="text-align:right;">
                <button class="btn" type="button" data-use="${esc(String(avg))}" style="padding:6px 10px; font-size:12px;">Средняя</button>
              </td>
            </tr>
          `;
        }).join("");

        monDot.className = "dot ok";
      } catch (e) {
        monBody.innerHTML = `<tr><td colspan="5" style="padding:12px; color:#ff6b6b;">Ошибка мониторинга: ${esc(String(e.message || e))}</td></tr>`;
        monDot.className = "dot";
      }
    }

    monRefreshBtn.addEventListener('click', loadMonitor);

    // Клик по кнопке "Средняя" -> подставить в общую цену
    monBody.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-use]');
      if (!btn) return;
      const value = btn.getAttribute('data-use') || "0";
      // ставим в поле глобальной цены и применяем
      globalPriceEl.value = String(value);
      applyGlobalPrice();
      globalPriceEl.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    // Инициализация
    updateSmallGiftsSum();
    recalc();
    loadMonitor();
    setInterval(loadMonitor, MON_REFRESH_MS);
  </script>
</body>
</html>




